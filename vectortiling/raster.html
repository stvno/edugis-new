
<!DOCTYPE html>
<meta charset="utf-8">
<title>Reprojected Raster Tiles</title>
<style>


body {
  margin-top: 0;
  font-family: Georgia, serif;
  text-align: center;
  background: #fff;
}

#map {
  position: relative;
  margin: 0 auto;
  overflow: hidden;
  border: solid 1px grey;
}

.gd3-layer path {
	stroke:black;
}

.q0-9 { fill:rgb(247,251,255); }
.q1-9 { fill:rgb(222,235,247); }
.q2-9 { fill:rgb(198,219,239); }
.q3-9 { fill:rgb(158,202,225); }
.q4-9 { fill:rgb(107,174,214); }
.q5-9 { fill:rgb(66,146,198); }
.q6-9 { fill:rgb(33,113,181); }
.q7-9 { fill:rgb(8,81,156); }
.q8-9 { fill:rgb(8,48,107); }
</style>

</figure>
<div id="map"></div>
<script src="../bower_components/d3/d3.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://www.jasondavies.com/maps/rotate/d3.geo.zoom.js"></script>

<script src="turf.js"></script>
<script src="http://www.jasondavies.com/maps/d3.quadtiles.js"></script>
<script src="d3.geo.vector.js"></script>

<script>

var rateById = d3.map();

var quantize = d3.scale.quantize()
    .domain([0, 100])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));

queue()
    .defer(d3.tsv, "buurten.tsv", function(d) { 
		rateById.set(d.BU_CODE, +d.P_GEHUWD);
	})
	.await(ready);

function ready(error, cbs){

var ratio = window.devicePixelRatio || 1,
    width = 1280 * ratio,
    height = 1024 * ratio;
 
var projection = d3.geo.mercator()
    .rotate([0, 0])
    .center([5, 52.4])
    .scale(80000 * ratio)
    .translate([0,0])
    .clipExtent([[0,0], [width, height]]);
  
var path = d3.geo.path()
    .projection(projection);

var vector = d3.geo.vector(projection,function(d) { 
		return quantize(rateById.get(d.feature.properties.bu_code)) + ' ' + d.feature.properties.bu_code; 
	})
    .scaleExtent([0, 14])
    .url("/buurtenid/{z}/{x}/{y}.topojson");

var kaart = d3.select("#map")
    .style("width", width / ratio + "px")
    .style("height", height / ratio + "px")
	.append("svg")
	.attr("width", width/ratio)
    .attr("height", height/ratio)
    .call(d3.behavior.zoom()
		.scale(projection.scale() / ratio)
		.scaleExtent([1e2, 5e6])
		.on("zoom", function() {
			var t = d3.event.translate,
            s = d3.event.scale;
			projection.translate([t[0] * ratio, t[1] * ratio]).scale(s * ratio);
			kaart.call(vector);
		})
	)
	.append("g")
	.call(vector)
	
}
</script>
